app-id: com.arkrith.ArkRinth
runtime: org.gnome.Platform
runtime-version: '45'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node18
command: arkrinth
finish-args:
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --filesystem=host
  - --talk-name=org.freedesktop.Secrets
modules:
  - name: arkrinth
    buildsystem: simple
    build-options:
      # Enable SDK extensions in the build environment
      append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/node18/bin
      build-args:
        - --share=network
      env:
        CARGO_HOME: /run/build/arkrinth/cargo
        RUSTUP_HOME: /run/build/arkrinth/rustup
        CARGO_TARGET_DIR: /run/build/arkrinth/target
        # Node.js environment
        NPM_CONFIG_CACHE: /run/build/arkrinth/npm-cache
        # Tauri build environment
        TAURI_PRIVATE_KEY: ""
        TAURI_KEY_PASSWORD: ""
    build-commands:
      # Install pnpm globally since it's not in the SDK by default
      - npm install -g pnpm
      # Print versions for debugging
      - rustc --version
      - node --version
      - npm --version
      - pnpm --version
      # Install frontend dependencies
      - pnpm install
      # Build the Tauri application
      - pnpm tauri build
      # Install the built binary
      - install -Dm755 src-tauri/target/release/arkrinth /app/bin/arkrinth
      # Install the icon (adjust path as needed)
      - install -Dm644 src-tauri/icons/128x128.png /app/share/icons/hicolor/128x128/apps/com.arkrith.ArkRinth.png
      # Install additional icon sizes if they exist
      - |
        for size in 32 64 128 256 512; do
          if [ -f "src-tauri/icons/${size}x${size}.png" ]; then
            install -Dm644 "src-tauri/icons/${size}x${size}.png" "/app/share/icons/hicolor/${size}x${size}/apps/com.arkrith.ArkRinth.png"
          fi
        done
      # Install the desktop file
      - install -Dm644 com.arkrith.ArkRinth.desktop /app/share/applications/com.arkrith.ArkRinth.desktop
      # Install the metainfo file
      - install -Dm644 com.arkrith.ArkRinth.metainfo.xml /app/share/metainfo/com.arkrith.ArkRinth.metainfo.xml
    sources:
      - type: git
        url: https://github.com/arc360alt/ArkRinthTesting
        tag: v1.2  # Change this to whatever tag you want to build
      # Include the desktop and metainfo files
      - type: file
        path: com.arkrith.ArkRinth.desktop
      - type: file
        path: com.arkrith.ArkRinth.metainfo.xml
